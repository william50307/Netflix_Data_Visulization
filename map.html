<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://d3js.org/topojson.v0.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

<body>

</body>
<!-- Create an element where the map will take place -->
<div id="my_dataviz">
  
</div>
<style>
  svg {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
  }

</style>
<script>
  const margin = { top: 40, right: 30, bottom: 60, left: 30 },
    width = 1000 - margin.left - margin.right,
    height = 700 - margin.top - margin.bottom;
  // The svg
  const svg = d3.select("#my_dataviz")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)


  // Map and projection
  const path = d3.geoPath();
  const projection = d3.geoMercator()
    .scale(140)
    .translate([width / 2, height / 1.4]);
  // Data and color scale
  const data = new Map();
  const g = svg.append("g");
  const colorScale = d3.scaleSequential().domain([0, 10]).interpolator(d3.interpolateBlues);

  // Load external data and boot
  Promise.all([
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"),
    d3.csv("https://raw.githubusercontent.com/zihong518/data_visualization/master/data.csv", function (d) {
      data.set(d.country, +d.averageRating)
    })]).then(function (loadData) {
      console.log(loadData[0])
      let topo = loadData[0]

      const tooltip = d3.select("#my_dataviz") //set tooltip
        .append("div")
        .style("opacity", 0)
        .attr("class", "tooltip")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "1px")
        .style("border-radius", "5px")
        .style("padding", "10px")
        .style("position", "absolute")

      const showTooltip = function (event, d) {
        d3.selectAll(".Country") //show the tooltip
          .transition()
          .duration(200)
          .style("opacity", .5)
        d3.select(this)
          .transition()
          .duration(200)
          .style("opacity", 1)
          .style("stroke", "black")

        // tooltip //display the remark 
        //   .transition()
        //   .duration(200)
        tooltip
          .style("opacity", 1)
          .html("This country is " + d.properties.name + ". This country's imdbScore is " + d.total)
          .style("left", (event.x) / 2 + "px") //set the position tooltip will show
          .style("top", (event.y) / 2 - 50 + "px")
      }
      const moveTooltip = function (event, d) {
        tooltip
          .style("left", (event.x) + "px")
          .style("top", (event.y) + "px")
      }
      const hideTooltip = function (event, d) {
        d3.selectAll(".Country")
          .transition()
          .duration(200)
          .style("opacity", .8)
        d3.select(this)
          .transition()
          .duration(200)
          .style("stroke", "transparent")
        tooltip
          .transition()
          .duration(200)
          .style("opacity", 0)
      }

      // Draw the map
      g.selectAll("path")
        .data(topo.features)
        .enter()
        .append("path")
        // draw each country
        .attr("d", d3.geoPath()
          .projection(projection)
        )
        // set the color of each country
        .attr("fill", function (d) {
          d.total = data.get(d.properties.name) || 0; //要改的地方 應該改成各國家平均
          return colorScale(d.total);
        })
        .style("stroke", "black")
        .attr("class", function (d) { return "Country" })
        .style("opacity", .8)
        .on("mouseover", showTooltip)
        .on("mousemove", moveTooltip)
        .on("mouseleave", hideTooltip)

      const zoom = d3.zoom()
      .scaleExtent([1, 8])
      .on('zoom', function(event) {
          g.selectAll('path')
          .attr('transform', event.transform);
    })

  svg.call(zoom)
})
</script>