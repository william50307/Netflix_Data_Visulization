<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Create a div where the graph will take place -->
<p>Total amount : <span id='amount'> </span></p>
<div id="my_dataviz"></div>

<select id='select_countrys'></select>
<div id='selected_countrys'></div>


<script>

	// set the dimensions and margins of the graph
	const margin = {top: 30, right: 30, bottom: 70, left: 60},
			width = 460 - margin.left - margin.right,
			height = 400 - margin.top - margin.bottom;
	
	// append the svg object to the body of the page
	const svg = d3.select("#my_dataviz")
		.append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		.append("g")
			.attr("transform", `translate(${margin.left},${margin.top})`);
	
	// Parse the Data

	d3.csv("netflix_v2.csv").then(async function(data) {
	
	
	const imgs = await d3.csv('https://raw.githubusercontent.com/zihong518/data_visualization/master/data.csv')
	
	// remove nan data and parse datetime string
	data = data.filter((element, i) => element.date_added && element.type === 'Movie' && element.country);

	const parseTime = d3.timeParse("%B %d, %Y");
	data.forEach(element => {
		// parse datetime data
		element.date_added  = parseTime(element.date_added); 
		//element.duration = +element.duration.split(' ')[0];
	});

		// get all genres and countrys
    let countrys_all = [];
    for(const d of data){
      // country
      for(const c of d.country.split(', ')){
        if (!countrys_all.includes(c) && c){
          countrys_all.push(c);
        }
      }
    }

		// show country options
	d3.select('#select_countrys')
		.selectAll('option')
		.data(countrys_all)
		.join('option')
		.attr('class', 'genre_para')
		.text((d) => d)

	d3.select('#select_countrys').on('change', update)


	function calculate_r(amount){

		if (amount === 1){
			return Math.min(width, height);
		} 
		else{
			for(let i=2; i<amount; i++){
				let guess_r = width / i;
				if (guess_r * Math.ceil(amount / i) < height){
					return Math.floor(guess_r);
				} 
			}
		}
	}

	function draw_images(data, x_amount){
		console.log(x_amount)
		svg
		.selectAll('image')
		.data(data)
		.join('image')
		.attr('href',`https://m.media-amazon.com/images/M/MV5BOTE0MjQ1NDU3OV5BMl5BanBnXkFtZTgwNTI4MTgwNzM@._V1_QL75_UX${ x.bandwidth() }_.jpg`)
		.attr("x", (d, i) => x(i % x_amount))
		.attr("y", (d, i) => y(Math.floor( i / x_amount)))
		.transition()
		.duration(1500)
		.attr("preserveAspectRatio","xMidYMid slice")
		.attr("width", x.bandwidth())
		.attr("height", x.bandwidth())
		// .attr("fill", d  => `url(#${d.show_id})`)
		.style('stroke', 'white')
		.style('stroke-width', '0.5px');

	}

	function update(event, d){

		const value = d3.select(this).property('value')

		let country_selected_block = d3.select('#selected_countrys')
			.append('div')
			.attr('class', value)
		
		country_selected_block
			.append('p')
			.text(value)

		country_selected_block
			.append('button')
			.attr('class', value)
			.text('remove')
			//.on('click', removeStackedBar)

		
		let countrys = []
		d3.selectAll('div#selected_countrys div').each(function(){ countrys.push(d3.select(this).attr('class')) })
		console.log(countrys)
		const filtered_data = data.filter( d => { 
			let t = false
			for (let c of countrys){
				t = t || d.country.split(', ').includes(c)
			}
			return t;
		})

		
		// update the data amount
		d3.select('#amount').text(filtered_data.length)

		// calculate the squre length
		const r = calculate_r(filtered_data.length)
		const x_amount = Math.floor(width / r);
		const y_amount = Math.floor(height / r);
		console.log(x_amount)
		// set new domain
		x.domain(d3.range(x_amount))
		y.domain(d3.range(y_amount))

		
		draw_images(filtered_data, x_amount);
		
	}



	d3.select('#amount').text(data.length);

	// calculat the lenght of square
	const r = calculate_r(data.length);
	const x_amount = Math.floor(width / r);
	const y_amount = Math.floor(height / r);

	
	// X axis
	const x = d3.scaleBand()
		.range([ 0, width ])
		.domain(d3.range(x_amount))
		.padding(0);

	// Y axis
	const y = d3.scaleBand()
		.range([ 0, height])
		.domain(d3.range(y_amount))
		
	draw_images(data, x_amount)
	
	})
</script>