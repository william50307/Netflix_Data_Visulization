<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>
<!-- <script src="https://d3js.org/d3.v6.min.js"></script> -->
<!-- time slider -->
<script src="https://unpkg.com/d3-simple-slider"></script> 

<script src="utils.js"></script>
<script src="time_slider.js"></script>

<!-- Create a div where the graph will take place -->
<p>Total amount : <span id='amount'> </span></p>
<div id="my_dataviz"></div>

<div id ='pixel_filter'>

	<select class='select_countrys' data-filter_type ='country' ></select>
	<div class='selected_country'></div>

	<select class='select_genres' data-filter_type = 'genre'></select>
	<div class='selected_genre'></div><br>

	<div id='duration'>
		<span>From : </span><span id='duration_min'>1</span>
		<span>To : </span><span id='duration_max'>312</span>
	</div>

	<div id='slider'>
			<span>From : </span><span id='time_min'>2008</span>
			<span>To : </span><span id='time_max'>2021</span>
	</div>

</div>


<script>

	// set the dimensions and margins of the graph
	const margin = {top: 30, right: 30, bottom: 70, left: 60},
			width = 800 - margin.left - margin.right,
			height = 680 - margin.top - margin.bottom;
	
	// append the svg object to the body of the page
	const svg = d3.select("#my_dataviz")
		.append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
		.append("g")
			.attr("transform", `translate(${margin.left},${margin.top})`);
	
	// Parse the Data

	d3.csv("https://raw.githubusercontent.com/zihong518/data_visualization/master/data.csv").then(async function(data) {
	
	// remove nan data and parse datetime string
	data = data.filter((element, i) => element.type==="Movie" && element.date_added && element.listed_in && element.country);

	const parseTime = d3.timeParse("%B %d, %Y");
	data.forEach(element => {
		// parse datetime data
		element.date_added  = parseTime(element.date_added); 
		element.duration = +element.duration.split(' ')[0];
		element.listed_in = element.listed_in.split(', ').map( d => d.replaceAll(' ','_').replaceAll('&', 'and')).join(', ')
		element.country = element.country.split(', ').map( d => d.replaceAll(' ','_')).join(', ')
	});


	//const filter_variables = ['countrys', 'genres']

	d3.select('#amount').text(data.length);

	// show country options and binding on change event
	let countrys_all = get_all_countrys(data)
	d3.select('#pixel_filter .select_countrys')
		.selectAll('option')
		.data(countrys_all)
		.join('option')
		.attr('class', 'country_para') 
		.text((d) => d)

	d3.select('#pixel_filter .select_countrys').on('change', add_and_update)

	// show genres options and binding onchange event
	let genres_all = get_all_genres(data)
	d3.select('.select_genres')
		.selectAll('option')
		.data(genres_all)
		.join('option')
		.attr('class', 'genre_para')
		.text((d) => d)

	d3.select('#pixel_filter .select_genres').on('change', add_and_update)
	//d3.select("#pixel_filter div.select_type").selectAll("input").on('change', add_and_update)

	// creatre time slider
	time_slider(d3.min( data.map( d => d.date_added)), update)
	// create duration slider
	duration_slider(...d3.extent( data.map(d => d.duration)), update)


	// calculat the lenght of square
	const r = calculate_r(data.length);
	const x_amount = Math.floor(width / r);
	const y_amount = Math.floor(height / r);
	
	const groupX = d3.scaleBand()
		.range([0, width])
		.padding(0.2)

	// X axis
	const x = d3.scaleBand()
		.range([ 0, width ])
		.domain(d3.range(x_amount))
		.padding(0);

	// Y axis
	const y = d3.scaleBand()
		.range([ 0, height])
		.domain(d3.range(y_amount))

	const color = d3.scaleOrdinal()
		.domain(genres_all)
		.range(genres_all.map( d => d3.hsl(Math.random()*360,0.8,0.6)))
	
	add_selected_country('Japan')

	// add default genres 
	//add_selected_genres()

	// init chart
	update() // testing
	//draw_images(data, x_amount)



	// calculate the las
	function calculate_r(amount){

		if (amount === 1){
			return Math.min(width, height);
		} 
		else{
			for(let i=2; i<amount; i++){
				let guess_r = width / i;
				if (guess_r * Math.ceil(amount / i) < height){
					return Math.floor(guess_r);
				} 
			}
		}
	}


	function get_all_condition_and_prepare_data(){

		const filters = d3.select('#pixel_filter');

		// get selected countrys
		let selected_countrys = []
		filters.selectAll('div.selected_country div').each(function(){ selected_countrys.push(d3.select(this).attr('data-country')) })
		//filters.select('selected_countrys')

		// get selected genres
		let selected_genres = []
		filters.selectAll('div.selected_genre div').each(function(){ selected_genres.push(d3.select(this).attr('data-genre')) })
		//filters.select('selected_genres')

		let min_max_duration = []
		filters.selectAll('g.duration_slider g.parameter-value').each((d) => min_max_duration.push(d.value))

		let min_max_time = []
		filters.selectAll('g.time_slider g.parameter-value').each((d) => min_max_time.push(d.value))

		let filtered_data = data.filter( d => { 
			
			// match counrtry
			let c_match = selected_countrys.length === 0 ? true : false 
			for (let c of selected_countrys){
				c_match = c_match || d.country.split(', ').includes(c)
			}

			// match genre
			let g_match = selected_genres.length === 0 ? true : false 
			for (let g of selected_genres){
				g_match = g_match || d.listed_in.split(', ').includes(g)
			}

			
			
			// match duration
			let d_match = d.duration > min_max_duration[0] && d.duration < min_max_duration[1] ? true : false
			// match time
			let t_match = d.date_added > min_max_time[0] && d.date_added < min_max_time[1] ? true : false


			return c_match && g_match  && d_match && t_match;// && d.type === type
		})
		
		// sort by matched genres and genre name
		if (selected_genres.length !== 0){
			filtered_data.forEach(function(d){
				let matched_genres = []
				d.listed_in.split(', ').map( function(g){
					if (selected_genres.includes(g)) matched_genres.push(g);
				})
				d.matched_genres = matched_genres
			})
			filtered_data.sort((a, b ) => a.matched_genres.length - b.matched_genres.length || a.matched_genres[0].localeCompare(b.matched_genres[0]))
		}

		return [filtered_data, selected_countrys, selected_genres];

	}

	// higlight seleted genres
	function groupHighlight(event, d){
		const genre = d3.select(this).text()
		d3.selectAll('g.image_gruop').style('opacity', 1)
		d3.selectAll(`g.${genre}`).style('opacity', 0.5)
	}

	// nohighlight 
	function groupNoHighlight(event, d){
		d3.selectAll('g.image_gruop').style('opacity', 0.8)
	}


	// hightlight only one image (mouseover and mouseleave use the same function)
	function highlight_over_or_leave(event, d){
		if (event.type === 'mouseover'){
			d3.select(this).attr('width', x.bandwidth() * 1.2).attr('height', x.bandwidth() * 1.2).style('opacity',0.8)
		}
		else{
			d3.select(this).attr('width', x.bandwidth()).attr('height', x.bandwidth()).style('opacity',0.8)
		}
	}
	
	function draw_images(data, x_amount, countrys, genres){
		
		d3.selectAll('#my_dataviz g.image_group').remove()
		
		const image_group = svg.selectAll('g.image_group')
			.data(data)
			.join('g')
			.attr('class',d =>  `image_group ${d.listed_in.replaceAll(', ', ' ')}` )
		
		// append rects according selected genres
		image_group.each(function(d, i){
			const toAppend = d3.select(this);
			const genresToShow = d.listed_in.split(', ').filter( d => genres.includes(d))
			const rect_X_Shift = x.bandwidth() / genresToShow.length
			for(let j=0; j < genresToShow.length; j++){
				toAppend.append('rect')
				.attr("x", x(i % x_amount) + rect_X_Shift * j )
				.attr("y", y(Math.floor( i / x_amount)))
				.attr("width", x.bandwidth() / genresToShow.length)
				.attr("height", x.bandwidth())
				.style('opacity', 1)
				.style('fill', color(genresToShow[j]));
			}
		}) ;
  
		
		// image_group.append('rect')
		// 	.attr("x", (d, i) => x(i % x_amount))
		// 	.attr("y", (d, i) => y(Math.floor( i / x_amount)))
		// 	.attr("width", x.bandwidth())
		// 	.attr("height", x.bandwidth())
		// 	.style('opacity', 1)
		// 	.style('fill', d => color(d.genre));

		
		image_group.append('image')
			.attr('href', d => d.image.replace(/(?<=@\.)(.+)(?=\.jpg)/, `UX${x.bandwidth()}`))
			.attr("x", (d, i) => x(i % x_amount))
			.attr("y", (d, i) => y(Math.floor( i / x_amount)))
			.on('mouseover', highlight_over_or_leave)  // we need to put event listener before transition
			.on('mouseleave', highlight_over_or_leave)
			.transition()
			.duration(1500)
			.style('opacity',0.5)
			.attr("preserveAspectRatio","xMidYMid slice")
			.attr("width", x.bandwidth())
			.attr("height", x.bandwidth())
			
	}

	function remove_selection(even, d){
		const id = d3.select(this).attr('class')
		d3.select(`div.${id}`).remove()

	}

	// get all conditions => redraw the chart
	function update(){
		const [filtered_data, countrys, genres] = get_all_condition_and_prepare_data() // testing
		
		// update the data amount
		d3.select('#amount').text(filtered_data.length)

		// calculate the squre length
		const r = calculate_r(filtered_data.length)
		const x_amount = Math.floor(width / r);
		const y_amount = Math.floor(height / r);

		// set new domain
		x.domain(d3.range(x_amount))
		y.domain(d3.range(y_amount))

		draw_images(filtered_data, x_amount, countrys, genres);
	}
	
	function add_selected_country(value){
		let country_selected_block = d3.select('.selected_country')
			.append('div')
			.attr('data-country', value)
		
		country_selected_block
			.append('p')
			.text(value)

		country_selected_block
			.append('button')
			.attr('data-country', value)
			.attr('class', 'country')
			.text('remove')
			.on('click', remove)
	}

	function add_selected_genre(value){
		let country_selected_block = d3.select('.selected_genre')
			.append('div')
			//.attr('class', value)
			.attr('data-genre', value)
			.style('display','flex')

			.style('align-items','center')
		
		country_selected_block
			.append('div')
			.style('border-radius','100%')
			.style('background-color', color(value))
			.style('width','15px')
			.style('height','15px')
			.text('   ')

		country_selected_block
			.append('p')
			.style('margin','0')
			.text(value)
			.on('mouseover', groupHighlight)
			.on('mouseleave', groupNoHighlight)

		country_selected_block
			.append('button')
			.attr('data-genre', value)
			.attr('class', 'genre')
			.text('remove')
			.on('click', remove)
	}

	// an event for countrys and genres
	function add_and_update(event, d){

		// to know country genre
	  const type = d3.select(this).attr('data-filter_type') 
		// selectd content
		const value = d3.select(this).property('value')

		// add selected country
		if (type === 'country'){
			add_selected_country(value)
		}
		// add selected genre
		else{
					add_selected_genre(value)
		}

		update();
	}

	// remove selected genres
	function remove(event, d){
		let type = d3.select(this).attr('class') === 'country' ? 'country' : 'genre'
		let value = d3.select(this).attr(`data-${type}`)
		d3.select(`div[data-${type}=${value}]`).remove()
		update()
	}


	})
</script>